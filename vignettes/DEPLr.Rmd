---
title: "DEPLr: A Simulation Depletion Model for Octopus"
author: "Abdelouahed BEN MHAMED"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{DEPLr}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
  
---

# Introduction

DEPLr is an implementation of a Monte Carlo simulation depletion model applied to octopus. This package allow the user to project the population of a stock, or different stocks of octopus with no interaction, in the future and get a summary of the state of the population. It also provides different outputs like:

1. The path of the abundance of the stock along the fishing season
2. The path of the biomass for each zone
3. The catch in number and weight along the weeks of the fishing season for each zone and fleet
4. And the cpue of each fleet in each zone


# Input file

There is an example of the input file in the package that could be uploaded using the _*DEPLSim*_ method. This input file include all basic elements needed to run the simulation model.

```{r}
library(DEPLr)
sim=DEPLSim(file = "/home/benmhamed/Wahid/my_packages/DEPLr/input/sim1.inp")
class(sim)
```

To have an overveiw of the DEPLSim object _sim_ we write:

```{r}
str(sim)
```

As you can see, there are eight main feilds in the DEPLSim object which we are going to present briefly:

1. _controle_: This slot is a _DEPLPar_ object which contains some parameters of the simulation model. To look further on it type _controle(sim)_. We used _knitr::kable_ just for formating the table to look like this:

```{r,results='asis'}
knitr::kable(controle(sim))
```

2. _params_: this slot is a _DEPLPar_ object which contains the parameters of the _Length-Weight_ relationship and the parameters of the _Growth_ function of the octopus.

3. _zones_: this slot is a _DEPLZone_ object. To have access to it we can use the following _script_:

```{r,fig.align='center',fig.width=8,fig.height=6}
zone <- zones(sim)
# Get the names of zones
names(zone)
# plot the proportion of initial abundance in each zone
plot(zone)
```


To get the fleets exploiting the zones we type:


```{r}
# Get the fleets exploiting the zones 
fleet <- fleet(zone)
# To obtain names of each fleet
names(fleet)
# To obtain the catchability of each fleet
catchability(fleet)
# To display the Fleets with their catchabilities in a data.frame
as.data.frame(fleet)

```

The last five fields of the DEPLSim object _sim_ are _catch.n__, _catch.wt_, _stock.n_, _stock.wt_ and _cpue_. These could be accessed with:

```{r}
catch.n(sim)
catch.wt(sim)
stock.n(sim)
stock.wt(sim)
index(sim)
```

As you can see, these objects are empty, so to have them full, we have to run the simulation model using _run_ method:

```{r,echo=FALSE,cache=TRUE,results='hide'}
 sim <- run(sim)
```
```{r}
# sim <- run(sim)
```
 3239 3397

After runing the model you can se that the empty feilds are now having values. To ge summaries of the stock abundance, biomass, the catch in numbers and weight, and the cpue we use the following _script_:

```{r}
# Computing a summary of the catch in numbers
catchN <- summary(object = sim,"catch.n")
catchWT <- summary(object = sim,"catch.wt")
stockN <- summary(object = sim,"stock.n")
stockWT <- summary(object = sim,"stock.wt")
cpue <- summary(object = sim,"cpue")
head(catchN)

```

```{r,fig.width=7,fig.height=4}
library(ggplot2)
ggplot(cpue, aes(week, median, fill = fleet)) +
   geom_bar(position = "dodge",stat="identity") + 
  facet_grid(facets = zone~.,scales="free_y") + 
  ggtitle("CPUE of different fleets in the different zones")

```

```{r,fig.width=7,fig.height=4}
ggplot(stockN, aes(week, median)) +
   geom_bar(aes(fill=median),stat="identity") + 
  facet_grid(facets = zone~.,scales="free_y") + 
  ggtitle("Abundance")

```

```{r,fig.width=7,fig.height=4}
ggplot(stockWT, aes(week, median)) +
   geom_bar(aes(fill=median),stat="identity") + 
  facet_grid(facets = zone~.,scales="free_y") + 
  ggtitle("Biomass (t)")

```



```{r,fig.width=7,fig.height=4}
library(plyr)
library(reshape2)
abundance <- stock.n(sim)
cpue <- index(sim)
dtN <- adply(.data = abundance,.margins = c(1,2,3),.fun = identity) 
names(dtN) <- c("iter","week","zone","value")
ggplot(dtN, aes(week, value)) +
   geom_boxplot() + 
  facet_grid(facets = zone~.,scales="free_y") + 
  ggtitle("Abundance ")

biomass <- stock.wt(sim)
dtB <- adply(.data = biomass,.margins = c(1,2,3),.fun = identity) 
names(dtB) <- c("iter","week","zone","value")
ggplot(dtB, aes(week, value)) +
   geom_boxplot() +
  facet_grid(facets = zone~.,scales="free_y") + 
  ggtitle("Biomass")

```

```{r,fig.width=7,fig.height=4}
cpue <- index(sim)
dtcpue <- adply(.data = cpue,.margins = c(1,2,3,4),.fun = identity)
names(dtcpue) <- c("iter","week","fleet","zone","value")
ggplot(dtcpue, aes(week, value)) +
   geom_boxplot() +
  facet_wrap(facets = zone~fleet,scales="free") + 
  ggtitle("CPUE (kg)")

catchn <- catch.n(sim)
dtcatchn <- adply(.data = catchn,.margins = c(1,2,3,4),.fun = identity)
names(dtcatchn) <- c("iter","week","fleet","zone","value")
ggplot(dtcatchn, aes(week, value)) +
   geom_boxplot() +
  facet_wrap(facets = zone~fleet,scales="free") + 
  ggtitle("Catch in Number")

catchwt <- catch.wt(sim)
dtcatchwt <- adply(.data = catchwt,.margins = c(1,2,3,4),.fun = identity)
names(dtcatchwt) <- c("iter","week","fleet","zone","value")
ggplot(dtcatchwt, aes(week, value)) +
   geom_boxplot() +
  facet_wrap(facets = zone~fleet,scales="free") + 
  ggtitle("Yeild (kg)")
```

